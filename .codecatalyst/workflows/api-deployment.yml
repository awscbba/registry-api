Name: API_Deployment_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  DeployAPI:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "ğŸš€ API Container Deployment"
            echo "=========================="
            echo "ğŸ“… Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

            # Install Python, uv, and Docker
            echo "ğŸ“¦ Installing Python, uv, and Docker..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

            # Install Docker
            yum update -y
            yum install -y docker
            service docker start

            # Verify installations
            which uv || echo "uv not found in PATH"
            uv --version || echo "uv version check failed"
            docker --version || echo "Docker version check failed"

            echo "â„¹ï¸ Using container-based deployment for Lambda"
            echo "ğŸ§ª Running critical pre-deployment tests..."
            
            # Install just if not available
            if ! command -v just >/dev/null 2>&1; then
                echo "ğŸ“¦ Installing just..."
                curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
                export PATH="/usr/local/bin:$PATH"
            fi

            # Run comprehensive test suite before deployment using just
            echo "ğŸš¨ Running comprehensive test suite (API + Frontend) with just..."
            if just test-full-stack; then
                echo "âœ… Comprehensive test suite passed - safe to deploy!"
            else
                echo "âŒ Comprehensive test suite failed - blocking deployment"
                exit 1
            fi

            # Container-based deployment for Lambda
            echo "ğŸ³ Building and deploying Lambda container..."

            # Build Docker container with Lambda Python 3.9 base
            docker build -f Dockerfile.lambda -t registry-api-lambda .

            echo "âœ… Lambda container built successfully"

            # Deploy using container deployment to ECR + Lambda
            echo "ğŸš€ Deploying container to AWS Lambda..."

            # Get git commit hash for tagging
            GIT_HASH=$(git rev-parse --short HEAD)
            echo "ğŸ“‹ Git commit hash: $GIT_HASH"

            # Check if we have AWS CLI access
            if aws sts get-caller-identity > /dev/null 2>&1; then
                echo "âœ… AWS CLI access confirmed"
                
                # ECR repository details
                ECR_REGISTRY="142728997126.dkr.ecr.us-east-1.amazonaws.com"
                ECR_REPOSITORY="registry-api-lambda"
                IMAGE_TAG="main-$GIT_HASH"
                LATEST_TAG="latest"
                IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
                LATEST_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$LATEST_TAG"
                
                # Login to ECR
                echo "ğŸ” Logging into ECR..."
                aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $ECR_REGISTRY
                
                # Tag and push container to ECR with both git hash and latest tags
                echo "ğŸ“¤ Pushing container to ECR..."
                docker tag registry-api-lambda:latest $IMAGE_URI
                docker tag registry-api-lambda:latest $LATEST_URI
                docker push $IMAGE_URI
                docker push $LATEST_URI
                echo "âœ… Container pushed with tags: $IMAGE_TAG and $LATEST_TAG"
                
                echo "âœ… Container pushed to ECR successfully"
                
                # Update Lambda function to use new container image (with git hash tag)
                echo "ğŸ”„ Updating Lambda function with new container..."
                FUNCTION_NAME="PeopleRegisterInfrastruct-PeopleApiFunction67A8223-xlC79QhrsKBe"
                
                if aws lambda update-function-code \
                    --function-name "$FUNCTION_NAME" \
                    --image-uri "$IMAGE_URI" \
                    --region us-east-1; then
                    echo "âœ… Lambda function updated with container successfully"
                    echo "ğŸ“‹ Using container: $IMAGE_URI"
                else
                    echo "âš ï¸ Lambda function update failed or function doesn't exist"
                    echo "â„¹ï¸ Container available at: $IMAGE_URI"
                fi
                
                # Also update the Router function with the router container
                echo "ğŸ”„ Building and updating Router function..."
                
                # Build router container
                docker build -f Dockerfile.router -t registry-router-lambda .
                
                # Router ECR details
                ROUTER_ECR_REPOSITORY="registry-router-lambda"
                ROUTER_IMAGE_TAG="main-$GIT_HASH"
                ROUTER_IMAGE_URI="$ECR_REGISTRY/$ROUTER_ECR_REPOSITORY:$ROUTER_IMAGE_TAG"
                ROUTER_LATEST_URI="$ECR_REGISTRY/$ROUTER_ECR_REPOSITORY:$LATEST_TAG"
                
                # Tag and push router container with both git hash and latest tags
                echo "ğŸ“¤ Pushing router container to ECR..."
                docker tag registry-router-lambda:latest $ROUTER_IMAGE_URI
                docker tag registry-router-lambda:latest $ROUTER_LATEST_URI
                docker push $ROUTER_IMAGE_URI
                docker push $ROUTER_LATEST_URI
                echo "âœ… Router container pushed with tags: $ROUTER_IMAGE_TAG and $LATEST_TAG"
                
                # Update Router Lambda function (with git hash tag)
                ROUTER_FUNCTION_NAME="PeopleRegisterInfrastructur-RouterFunction6AC6EF3B-cFuTZOTV5Cjd"
                
                if aws lambda update-function-code \
                    --function-name "$ROUTER_FUNCTION_NAME" \
                    --image-uri "$ROUTER_IMAGE_URI" \
                    --region us-east-1; then
                    echo "âœ… Router function updated with container successfully"
                    echo "ğŸ“‹ Using container: $ROUTER_IMAGE_URI"
                else
                    echo "âš ï¸ Router function update failed or function doesn't exist"
                    echo "â„¹ï¸ Router container available at: $ROUTER_IMAGE_URI"
                fi
            else
                echo "âš ï¸ No AWS CLI access - container built but not deployed"
                echo "â„¹ï¸ Container ready for manual deployment"
            fi

            # Health check (if API endpoint is available)
            echo "ğŸ¥ Running health check..."
            API_URL="https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod"

            echo "â³ Waiting for container deployment to be ready..."
            sleep 10  # Give container deployment time to initialize

            echo "â³ Checking if API is available..."
            if curl -sf "$API_URL/subscriptions" > /dev/null 2>&1; then
                echo "âœ… Health check passed - API is responding"
                
                # Test key endpoints
                echo "ğŸ” Testing key endpoints..."
                if curl -s "$API_URL/subscriptions" | grep -q "subscriptions\|message"; then
                    echo "âœ… Subscriptions endpoint responding"
                else
                    echo "âš ï¸ Subscriptions endpoint may have issues"
                fi
            else
                echo "â„¹ï¸ API endpoint not immediately available (normal for container deployments)"
                echo "â„¹ï¸ Container may still be initializing - check logs if issues persist"
            fi

            echo "âœ… Container deployment completed"
            echo "â„¹ï¸ Lambda functions now using container-based deployment"
            echo ""
            echo "ğŸ“‹ Deployment Summary:"
            echo "======================"
            echo "ğŸ”– Git Commit: $GIT_HASH"
            echo "ğŸ³ API Container: $ECR_REGISTRY/$ECR_REPOSITORY:main-$GIT_HASH"
            echo "ğŸ”€ Router Container: $ECR_REGISTRY/$ROUTER_ECR_REPOSITORY:main-$GIT_HASH"
            echo "ğŸ”„ Both containers also tagged as 'latest'"
            echo "â±ï¸ End: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: deploymentResults
          Files:
            - "src/**/*"

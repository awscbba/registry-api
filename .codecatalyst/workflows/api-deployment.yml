Name: API_Deployment_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  DeployAPI:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "üöÄ API Deployment"
            echo "================"
            echo "üìÖ Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            
            # Install Python and uv
            echo "üì¶ Installing Python and uv..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
            
            # Verify uv installation
            which uv || echo "uv not found in PATH"
            uv --version || echo "uv version check failed"
            
            # Setup environment
            echo "üì¶ Setting up environment..."
            uv venv --python=python3.13 --clear
            source .venv/bin/activate
            uv pip install -r requirements.txt
            uv pip install pytest flake8 black
            
            # Validate critical dependencies are installed
            echo "üîç Validating dependencies..."
            python -c "
            import sys
            try:
                import fastapi, boto3, pytest
                print('‚úÖ All critical dependencies installed successfully')
            except ImportError as e:
                print(f'‚ùå Missing critical dependency: {e}')
                sys.exit(1)
            "
            
            # Run tests
            echo "üß™ Running tests..."
            export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
            python -m pytest tests/ --verbose || {
                echo "‚ùå Tests failed"
                exit 1
            }
            
            # Run linting
            echo "üîç Running linting..."
            flake8 src/ tests/ --max-line-length=88 || {
                echo "‚ùå Linting failed"
                exit 1
            }
            
            # Deploy - sync code to infrastructure repo
            echo "üîÑ Syncing code to infrastructure..."
            
            # Install git
            git config --global user.name "CodeCatalyst API Sync"
            git config --global user.email "codecatalyst@aws.com"
            
            # Clone infrastructure repo
            INFRA_REPO="https://git.us-west-2.codecatalyst.aws/v1/AWSCocha/people-registry-03/registry-infrastructure"
            
            if git clone "$INFRA_REPO" ../registry-infrastructure; then
                echo "‚úÖ Infrastructure repo cloned"
                cd ../registry-infrastructure
                
                # Create sync branch
                SYNC_BRANCH="api-sync-$(date +%Y%m%d-%H%M%S)"
                git checkout -b "$SYNC_BRANCH"
                
                # Sync API code
                rm -rf lambda/src/
                rm -f lambda/main.py
                cp -r ../registry-api/src lambda/
                cp ../registry-api/main.py lambda/
                
                # Update requirements
                cp ../registry-api/requirements.txt lambda/
                
                # Commit and push
                git add .
                git commit -m "Sync API code from registry-api"
                git push origin "$SYNC_BRANCH"
                
                echo "‚úÖ Code synchronized to branch: $SYNC_BRANCH"
            else
                echo "‚ùå Failed to clone infrastructure repo"
                exit 1
            fi
            
            # Basic health check
            echo "üè• Running health check..."
            API_URL="https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod"
            
            # Health check with proper polling
            echo "üè• Running health check..."
            API_URL="https://2t9blvt2c1.execute-api.us-east-1.amazonaws.com/prod"
            
            echo "‚è≥ Waiting for API to become available..."
            for i in {1..30}; do
                if curl -sf "$API_URL/health" > /dev/null 2>&1; then
                    echo "‚úÖ Health check passed - API is healthy"
                    break
                fi
                echo "‚è≥ Waiting for API... ($i/30)"
                sleep 2
            done
            
            # Final health check with detailed output
            if curl -s "$API_URL/health" | grep -q "healthy"; then
                echo "‚úÖ Final health check passed"
            else
                echo "‚ö†Ô∏è Health check failed (API may need more time to deploy)"
            fi
            
            echo "‚úÖ Deployment completed"
            echo "‚è±Ô∏è End: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: deploymentResults
          Files:
            - "src/**/*"
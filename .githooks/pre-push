#!/bin/bash
# Git pre-push hook for registry-api
# Comprehensive validation: formatting, linting, testing, and build checks

echo "ğŸ” Running comprehensive pre-push validation..."

# Get the git repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Change to repository root
cd "$REPO_ROOT"

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Error: Not in registry-api root directory"
    echo "ğŸ“ Current directory: $(pwd)"
    echo "ğŸ“ Expected files: pyproject.toml, src/, .flake8"
    echo "ğŸ’¡ The hook should run from the repository root"
    exit 1
fi

# Check if uv is available
if ! command -v uv &> /dev/null; then
    echo "âŒ Error: uv is not installed or not in PATH"
    echo "ğŸ’¡ Install uv: curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

# 1. CODE FORMATTING
echo "ğŸ“ Running black formatter..."
uv run black .
if [ $? -ne 0 ]; then
    echo "âŒ Black formatting failed"
    exit 1
fi

# Check if any files were changed by black
if ! git diff --quiet; then
    echo "ğŸ“ Black made formatting changes"
    echo "ğŸ’¡ Files have been formatted. Please review and commit the changes:"
    git diff --name-only
    echo ""
    echo "ğŸ”„ You can:"
    echo "   1. Review the changes: git diff"
    echo "   2. Add the changes: git add ."
    echo "   3. Commit the changes: git commit -m 'style: apply black formatting'"
    echo "   4. Push again: git push"
    echo ""
    echo "âš ï¸  Push cancelled to allow you to commit formatting changes"
    exit 1
fi

# 2. CODE LINTING
echo "ğŸ” Running flake8 linter..."
uv run flake8
if [ $? -ne 0 ]; then
    echo "âŒ Flake8 linting failed"
    echo "ğŸ’¡ Fix the linting issues above and try pushing again"
    exit 1
fi

# 3. SYNTAX VALIDATION
echo "ğŸ” Running syntax validation..."
if command -v just &> /dev/null; then
    just validate-syntax
    if [ $? -ne 0 ]; then
        echo "âŒ Syntax validation failed"
        echo "ğŸ’¡ Fix syntax errors and try pushing again"
        exit 1
    fi
else
    echo "âš ï¸  Just not available, skipping syntax validation"
fi

# 4. COMPREHENSIVE TEST SUITE
echo "ğŸ§ª Running comprehensive test suite..."
if command -v just &> /dev/null; then
    # Run the comprehensive test suite that would have caught production bugs
    just test-comprehensive
    if [ $? -ne 0 ]; then
        echo "âŒ Comprehensive test suite failed"
        echo "ğŸ’¡ Fix the failing tests and try pushing again"
        echo "ğŸ” Run 'just test-comprehensive' for detailed test output"
        echo ""
        echo "ğŸ“Š Test categories that failed:"
        echo "   - Critical integration tests (prevent production bugs)"
        echo "   - Async/sync validation tests"
        echo "   - Code quality checks"
        exit 1
    fi
else
    # Fallback: run critical tests directly
    echo "âš ï¸  Just not available, running critical tests directly..."
    uv run pytest tests/test_critical_integration.py tests/test_modernized_async_validation.py --tb=short -q
    if [ $? -ne 0 ]; then
        echo "âŒ Critical tests failed"
        echo "ğŸ’¡ Fix the failing critical tests and try pushing again"
        exit 1
    fi
fi

# 5. PRODUCTION READINESS CHECK
echo "ğŸš€ Running production readiness check..."
if command -v just &> /dev/null; then
    just production-ready-check
    if [ $? -ne 0 ]; then
        echo "âŒ Production readiness check failed"
        echo "ğŸ’¡ Address production readiness issues and try pushing again"
        exit 1
    fi
else
    echo "âš ï¸  Just not available, skipping production readiness check"
fi

echo "âœ… All API repository checks passed!"
echo "ğŸ“Š Validation completed:"
echo "   âœ… Code formatting (black)"
echo "   âœ… Code linting (flake8)"
echo "   âœ… Syntax validation"
echo "   âœ… Comprehensive test suite"
echo "   âœ… Production readiness check"
echo ""
echo "ğŸš€ API repository ready for push!"
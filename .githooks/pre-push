#!/bin/bash
# Git pre-push hook for registry-api
# Automatically runs formatting and linting before each push

echo "ğŸ” Running pre-push checks..."

# Get the git repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Change to repository root
cd "$REPO_ROOT"

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Error: Not in registry-api root directory"
    echo "ğŸ“ Current directory: $(pwd)"
    echo "ğŸ“ Expected files: pyproject.toml, src/, .flake8"
    echo "ğŸ’¡ The hook should run from the repository root"
    exit 1
fi

# Check if uv is available
if ! command -v uv &> /dev/null; then
    echo "âŒ Error: uv is not installed or not in PATH"
    echo "ğŸ’¡ Install uv: curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

# Run black formatter
echo "ğŸ“ Running black formatter..."
uv run black .
if [ $? -ne 0 ]; then
    echo "âŒ Black formatting failed"
    exit 1
fi

# Check if any files were changed by black
if ! git diff --quiet; then
    echo "ğŸ“ Black made formatting changes"
    echo "ğŸ’¡ Files have been formatted. Please review and commit the changes:"
    git diff --name-only
    echo ""
    echo "ğŸ”„ You can:"
    echo "   1. Review the changes: git diff"
    echo "   2. Add the changes: git add ."
    echo "   3. Commit the changes: git commit -m 'style: apply black formatting'"
    echo "   4. Push again: git push"
    echo ""
    echo "âš ï¸  Push cancelled to allow you to commit formatting changes"
    exit 1
fi

# Run flake8 linter
echo "ğŸ” Running flake8 linter..."
uv run flake8
if [ $? -ne 0 ]; then
    echo "âŒ Flake8 linting failed"
    echo "ğŸ’¡ Fix the linting issues above and try pushing again"
    exit 1
fi

# Run critical passing tests to catch failures early
echo "ğŸ§ª Running critical passing tests..."
if command -v just &> /dev/null; then
    just test-critical-passing
    if [ $? -ne 0 ]; then
        echo "âŒ Critical tests failed"
        echo "ğŸ’¡ Fix the failing critical tests and try pushing again"
        echo "ğŸ” Run 'just test-critical-passing' for detailed test output"
        exit 1
    fi
else
    # Fallback if just is not available
    uv run pytest tests/test_critical_integration.py::TestCriticalIntegration::test_api_service_method_consistency tests/test_critical_integration.py::TestCriticalIntegration::test_async_sync_consistency tests/test_critical_integration.py::TestCriticalIntegration::test_v2_response_format_consistency tests/test_critical_integration.py::TestProductionHealthChecks::test_production_api_health tests/test_address_field_standardization.py --tb=short -q
    if [ $? -ne 0 ]; then
        echo "âŒ Critical tests failed"
        echo "ğŸ’¡ Fix the failing critical tests and try pushing again"
        echo "ğŸ” Run 'uv run pytest -v' for detailed test output"
        exit 1
    fi
fi

echo "â„¹ï¸ Frontend tests are handled in the registry-frontend repo"

echo "âœ… All pre-push checks passed!"
echo "ğŸš€ Proceeding with push..."
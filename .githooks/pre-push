#!/bin/bash
# Git pre-push hook for registry-api
# Comprehensive validation using just tasks

# Get current branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ” Running pre-push quality checks for branch: $BRANCH_NAME"

# Get the git repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Error: Not in registry-api root directory"
    exit 1
fi

# Validate branch name (prevent direct pushes to main)
if [ "$BRANCH_NAME" = "main" ]; then
    echo "âŒ Direct pushes to main branch are not allowed"
    echo "ğŸ’¡ Create a feature branch: git checkout -b feature/your-feature-name"
    echo "ğŸ’¡ Then create a pull request for code review"
    exit 1
fi

echo "âœ… Branch check passed: $BRANCH_NAME"

# Check if just is available
if ! command -v just &> /dev/null; then
    echo "âŒ Error: just is not installed or not in PATH"
    echo "ğŸ’¡ Install just: https://github.com/casey/just#installation"
    exit 1
fi

# 1. FORMATTING CHECK (should already be done by pre-commit)
echo "ğŸ¨ Running Black formatting check..."
if ! just format > /dev/null 2>&1; then
    echo "âŒ Code formatting issues found"
    echo "ğŸ’¡ Run 'just format' to fix formatting"
    echo "ğŸ’¡ Or ensure pre-commit hook is working: just setup-git-hooks"
    exit 1
fi

# Check if formatting made any changes
if ! git diff --quiet; then
    echo "âŒ Code formatting changes detected"
    echo "ğŸ’¡ Commit the formatting changes first"
    exit 1
fi
echo "âœ… Black formatting check passed"

# 2. CODE LINTING
echo "ğŸ” Running Flake8 linting..."
if ! just lint > /dev/null 2>&1; then
    echo "âŒ Linting issues found"
    echo "ğŸ’¡ Run 'just lint' to see detailed linting errors"
    exit 1
fi
echo "âœ… Flake8 linting check passed"

# 3. CRITICAL TESTS (including our new router function tests)
echo "ğŸ§ª Running critical tests..."
if ! uv run pytest tests/test_router_function.py tests/test_critical_integration.py tests/test_modernized_async_validation.py -q; then
    echo "âŒ Critical tests failed"
    echo "ğŸ’¡ Run 'just test-critical' for detailed output"
    echo "ğŸ’¡ These tests prevent production bugs - they must pass"
    exit 1
fi
echo "âœ… Critical tests passed"

# 4. FULL TEST SUITE
echo "ğŸ§ª Running full test suite..."
if ! just test-all > /dev/null 2>&1; then
    echo "âŒ Test suite failed - push blocked"
    echo "ğŸ’¡ Run 'just test-all' to see detailed test results"
    echo "ğŸ’¡ All tests must pass before pushing to maintain code quality"
    exit 1
else
    echo "âœ… All tests passed"
fi

echo "ğŸ‰ All quality checks passed! Push allowed to $BRANCH_NAME"